---
title: "COGS137 Final Project: California Automobile Accidents 2021"
author: "Adya Mishra, Connor McManigal, Donggyu(Alex) Yu, Mohamed Abdilahi - Data Dream Team"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

## Introduction
- INTRODUCTION HERE

### Load packages
```{r load-packages, message=FALSE}
library(tidyverse)
library(tidymodels)
library(olsrr)
library(skimr)
library(lubridate)
```

## Questions

**1. In 2021, is there a relationship between the severity of car accidents and weather conditions in California?**

**2. In San Diego County, is there a relationship between severity of accidents and road infrastructure?**

## The Data
- TALK ABOUT THE DATA HERE
- Explain variables(both ones we ended up using and not using)
- Original data set: 2,845,342 observations and 47 variables
- Wrangled CA data set: 388,838 observations and 38 variables
- SD data set: 24,177 observations and 38 variables

### Data Import
```{r, message = FALSE, warning = FALSE}
crash <- read_csv("/home/cmcmanig/COGS 137/data_dream_team/US_Accidents_Dec21_updated.csv")
```

### Data Wrangling

#### Extract Year and Filter For California Accidents That Happened in 2021
- 
```{r, eval = FALSE}
crash$Year <- substr(crash$Start_Time, 1, 4)
crash2021 <- crash[crash$Year == "2021", ]

crashCA <- crash2021 |>
  filter(State == "CA")
```

#### Extract Month and Day: Create Month and Day Variables
- 
```{r, eval = FALSE}
crashCA$Month <- substr(crashCA$Start_Time, 6, 7)
```

```{r, eval = FALSE}
crashCA$Day <- substr(crashCA$Start_Time, 9, 10)
```

#### Select Desired Variables and Arrange In An Order That Makes Sense
- 
```{r, eval = FALSE}
crashCA <- crashCA |>
  select("ID", "Day", "Month", "Year", "Zipcode", "County", "City", "Street", "Severity", "Start_Lat", "Start_Lng", "Distance(mi)", "Side", "Sunrise_Sunset", "Temperature(F)", "Wind_Chill(F)", "Humidity(%)", "Pressure(in)", "Visibility(mi)", "Wind_Direction", "Wind_Speed(mph)", "Precipitation(in)", "Weather_Condition", "Amenity", "Bump", "Crossing", "Give_Way", "Junction", "No_Exit", "Railway", "Roundabout", "Station", "Stop", "Traffic_Calming", "Traffic_Signal", "Turning_Loop")

head(crashCA)
```

#### Rename Variables Containing Units & Change Variables to Only First Letter Capitalized 
- 
```{r, eval = FALSE}
crashCA <- crashCA |>
  rename(Latitude = "Start_Lat",
         Longitude = "Start_Lng",
         Distance = "Distance(mi)",
         Temperature = "Temperature(F)",
         Wind_chill = "Wind_Chill(F)",
         Humidity = "Humidity(%)",
         Pressure = "Pressure(in)",
         Visibility = "Visibility(mi)",
         Wind_direction = "Wind_Direction",
         Wind_speed = "Wind_Speed(mph)",
         Precipitation = "Precipitation(in)",
         Weather_condition = "Weather_Condition",
         Give_way = "Give_Way",
         No_exit = "No_Exit",
         Traffic_calming = "Traffic_Calming",
         Traffic_signal = "Traffic_Signal",
         Turning_loop = "Turning_Loop",
         Time_of_day = "Sunrise_Sunset")
```

#### Save and Load Wrangled Data Because of Memory in RStudio
- 
```{r, eval = FALSE, echo = FALSE}
save(crashCA, file = "wrangled_crashCA.rda")
```

```{r, eval = FALSE, echo = FALSE}
load("wrangled_crashCA.rda")
```

#### Arrange in Chronological Order and Change Variable Types
- 
```{r, eval = FALSE}
crashCA <- crashCA |>
  arrange(Month, Day) |>
  mutate(Day = as.numeric(Day),
         Month = as.numeric(Month),
         Year = as.numeric(Year))
```

#### Create Date Variable
-
```{r, eval = FALSE}
crashCA$Date <- dmy(paste(crashCA$Day, crashCA$Month, crashCA$Year, sep = "-"))
```

#### Create Function to Normalize Weather Condition Values
- 56 unique values that need to be filtered and categorized
- define each category and what it includes
```{r, eval = FALSE}
categorize_weather <- function(weather_data) {
  
  lookup <- tibble( # create look up table for referencing
    Category = c("Fair", "Cloudy", "Stormy", "Windy", "Foggy", "Snowy", "Other"),
    Keyword = list(
      c("fair"),
      c("cloudy", "overcast", "partly cloudy", "mostly cloudy"),
      c("rain", "storm", "hail", "thunder", "heavy rain", "light rain", "heavy rain", "precipitation", "rain shower", "showers", "drizzle"),
      c("windy", "squalls"),
      c("fog", "mist", "haze"),
      c("snow", "ice", "heavy snow", "light snow", "wintry mix"),
      c("smoke", "duststorm", "dust")
    )
  )
  
  match_weather <- function(x) { # create function to extract keywords and place in proper weather category
    if(is.na(x)) {
      return(NA)
    }
    x <- tolower(x)
    for (i in 1:length(lookup$Category)) {
      pattern <- paste0(lookup$Keyword[[i]], collapse = "|")
      if(any(str_detect(x, pattern))) {
        return(lookup$Category[i])
      }
    }
    return(lookup$Category[length(lookup$Category)])
  }
  
  weather_data <- weather_data |> # apply the match_weather function
    mutate(Weather_category = sapply(Weather_condition, match_weather)) # create new variable(Weather_category) that takes in Weather_condition and applies function on its values
  
  return(weather_data)
}
```

#### Apply the Function From Above
- 
```{r, eval = FALSE}
crashCA <- categorize_weather(crashCA)
crashCA
```

#### Check Weather Category Counts
- 
```{r, eval = FALSE}
crashCA |>
  count(Weather_category) |>
  arrange(desc(n))
```

#### Rearange Variables
- 
```{r, eval = FALSE}
crashCA <- crashCA |>
  select("ID", "Day", "Month", "Year", "Date", "Zipcode", "County", "City", "Street", "Severity", "Latitude", "Longitude", "Distance", "Side", "Time_of_day", "Temperature", "Wind_chill", "Humidity", "Pressure", "Visibility", "Wind_direction", "Wind_speed", "Precipitation", "Weather_condition", "Weather_category", "Amenity", "Bump", "Crossing", "Give_way", "Junction", "No_exit", "Railway", "Roundabout", "Station", "Stop", "Traffic_calming", "Traffic_signal", "Turning_loop")
```

#### Filter For San Diego County
- 
```{r, eval = FALSE}
crashSD <- crashCA |>
  filter(County == "San Diego")
```

#### Save the Data
- 
```{r, eval = FALSE}
save(crashCA, crashSD, file = "wrangled_crashCA_crashSD.rda")
```


## Analysis
```{r}
load("wrangled_crashCA_crashSD.rda")
```

### Exploratory Data Analysis

```{r}
skim(crashCA)
```

```{r}
skim(crashSD)
```


### Data Analysis

#### Question 1: In 2021, is there a relationship between the severity of car accidents and weather conditions in California?



#### Q1: What's the answer?


#### Question 2: In San Diego County, is there a relationship between severity of accidents and road infrastructure and conditions?



#### Q2: What's the answer?



### Results
- RESULTS HERE

## Conclusion
- CONCLUSION HERE
