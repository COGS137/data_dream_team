---
title: "COGS137 Final Project: San Diego County Automobile Accidents 2021"
author: "Adya Mishra, Connor McManigal, Donggyu(Alex) Yu, Mohamed Abdilahi - Data Dream Team"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

## Introduction
- INTRODUCTION HERE

### Load packages
```{r load-packages, message=FALSE}
library(tidyverse)
library(tidymodels)
library(olsrr)
library(skimr)
library(lubridate)
```

## Questions

**1. Based on the 2021 accident records in San Diego County, which day and month have the most accidents?**

**2. How does season and weather conditions impact the frequency of accidents on a given day in 2021, and what is the relationship between them?**

## The Data
- TALK ABOUT THE DATA HERE
- Explain variables(both ones we ended up using and not using)
- Original data set: 2,845,342 observations and 47 variables
- Wrangled SD crash data set: 23,915 observations and 39 variables

### Data Import
```{r, message = FALSE, warning = FALSE}
crash <- read_csv("/home/cmcmanig/COGS 137/data_dream_team/US_Accidents_Dec21_updated.csv")
```

### Data Wrangling

#### Filter For San Diego County
- 
```{r, eval = FALSE}
crash <- crash |>
  filter(County == "San Diego")
```

#### Extract Year, Month, and Day and Create Variables
- 
```{r, eval = FALSE}
crash$Year <- substr(crash$Start_Time, 1, 4)
```

```{r, eval = FALSE}
crash$Month <- substr(crash$Start_Time, 6, 7)
```

```{r, eval = FALSE}
crash$Day <- substr(crash$Start_Time, 9, 10)
```

#### Create Date Variable
-
```{r, eval = FALSE}
crash$Date <- dmy(paste(crash$Day, crash$Month, crash$Year, sep = "-"))
```

#### Filter for 2021
-
```{r}
crash <- crash |>
  filter(Year == 2021)
```

#### Select Desired Variables and Arrange In An Order That Makes Sense
- 
```{r, eval = FALSE}
crash <- crash |>
  select("ID", "Day", "Month", "Year", "Date", "Zipcode", "County", "City", "Severity", "Start_Lat", "Start_Lng", "Distance(mi)", "Side", "Sunrise_Sunset", "Temperature(F)", "Wind_Chill(F)", "Humidity(%)", "Pressure(in)", "Visibility(mi)", "Wind_Direction", "Wind_Speed(mph)", "Precipitation(in)", "Weather_Condition", "Amenity", "Bump", "Crossing", "Give_Way", "Junction", "No_Exit", "Railway", "Roundabout", "Station", "Stop", "Traffic_Calming", "Traffic_Signal", "Turning_Loop")

head(crash)
```

#### Rename Variables Containing Units & Change Variables to Only First Letter Capitalized 
- 
```{r, eval = FALSE}
crash <- crash |>
  rename(Latitude = "Start_Lat",
         Longitude = "Start_Lng",
         Distance = "Distance(mi)",
         Temperature = "Temperature(F)",
         Wind_chill = "Wind_Chill(F)",
         Humidity = "Humidity(%)",
         Pressure = "Pressure(in)",
         Visibility = "Visibility(mi)",
         Wind_direction = "Wind_Direction",
         Wind_speed = "Wind_Speed(mph)",
         Precipitation = "Precipitation(in)",
         Weather_condition = "Weather_Condition",
         Give_way = "Give_Way",
         No_exit = "No_Exit",
         Traffic_calming = "Traffic_Calming",
         Traffic_signal = "Traffic_Signal",
         Turning_loop = "Turning_Loop",
         Time_of_day = "Sunrise_Sunset")
```

```{r, eval = FALSE, echo = FALSE}
save(crash, file = "wrangled_crash.rda")
```

```{r, eval = FALSE, echo = FALSE}
load("wrangled_crash.rda")
```

#### Change Variable Types to Numerics
- 
```{r, eval = FALSE}
crash <- crash |>
  mutate(Day = as.numeric(Day),
         Month = as.numeric(Month),
         Year = as.numeric(Year))
```

#### Create Function to Normalize Weather Condition Values 
- 56 unique weather condition values that need to be filtered and categorized
- define each category and what it includes
```{r, eval = FALSE}
categorize_weather <- function(weather_data) {
  lookup <- tibble( # create look up table for referencing
    Category = c("Fair", "Cloudy", "Stormy", "Foggy", "Snowy", "Other"),
    Keyword = list(
      c("fair", "clear"),
      c("cloudy", "overcast", "partly cloudy", "mostly cloudy", "clouds"),
      c("rain", "storm", "hail", "thunder", "heavy rain", "light rain", "heavy rain", "precipitation", "rain shower", "showers", "drizzle"),
      c("fog", "mist", "haze"),
      c("snow", "ice", "heavy snow", "light snow", "wintry mix"),
      c("smoke", "duststorm", "dust", "ash")
    )
  )
  match_weather <- function(x) { # create function to extract keywords and place in proper weather category
    if(is.na(x)) {
      return(NA)
    }
    x <- tolower(x)
    for (i in 1:length(lookup$Category)) {
      pattern <- paste0(lookup$Keyword[[i]], collapse = "|")
      if(any(str_detect(x, pattern))) {
        return(lookup$Category[i])
      }
    }
    return(lookup$Category[length(lookup$Category)])
  }
  weather_data <- weather_data |> # apply the match_weather function
    mutate(Weather_category = sapply(Weather_condition, match_weather)) # create new variable(Weather_category) using Weather_condition values
  
  return(weather_data)
}
```

#### Apply the Function From Above
- 
```{r, eval = FALSE}
crash <- categorize_weather(crash)
head(crash)
```

#### Check Weather Category Counts
- 
```{r, eval = FALSE}
crash |>
  count(Weather_category) |>
  arrange(desc(n))
```

#### Arrange in Chronological Order and Fix City Values
- 
```{r, eval = FALSE}
crash <- crash |>
  arrange(Year, Month, Day) |>
  mutate(City = case_when(City == "Cardiff By the Sea" ~ "Cardiff By The Sea", # two cases of Cardiff By The Sea(combine)
         TRUE ~ City)) |>
  filter(City != "San Clemente") # this city is from Orange County
```

#### Create Daily Accident Total
- 
```{r}
crash <- crash |>
  group_by(Day, Month, Year) |>
  mutate(Daily_total = n()) |>
  ungroup()
```

#### Create Season Variable
- 
```{r}
crash <- crash |>
  mutate(Season = case_when(
    Month %in% c(12, 1, 2) ~ "Winter",
    Month %in% c(3, 4, 5) ~ "Spring",
    Month %in% c(6, 7, 8) ~ "Summer",
    Month %in% c(9, 10, 11) ~ "Fall"
  ))
```

#### Rearange Variables into Our Desired Order
- 
```{r, eval = FALSE}
crash <- crash |>
  select("ID", "Day", "Month", "Year", "Date", "Season", "Zipcode", "County", "City", "Severity", "Latitude", "Longitude", "Distance", "Side", "Time_of_day", "Daily_total", "Temperature", "Wind_chill", "Humidity", "Pressure", "Visibility", "Wind_direction", "Wind_speed", "Precipitation", "Weather_condition", "Weather_category", "Amenity", "Bump", "Crossing", "Give_way", "Junction", "No_exit", "Railway", "Roundabout", "Station", "Stop", "Traffic_calming", "Traffic_signal", "Turning_loop")
```

#### Save the Data
- Here we save our finalized tibble that we will use for our EDA and analysis.
```{r, eval = FALSE}
save(crash, file = "final_wrangled_crash.rda")
```


## Analysis
```{r}
load("final_wrangled_crash.rda")
```


### Exploratory Data Analysis

```{r}
skim(crash)
```

```{r}
ggplot(crash, aes(x = Year)) +
  geom_bar()
```

```{r}
ggplot(crash, aes(x = fct_infreq(Weather_category))) +
  geom_bar()
```

```{r}
ggplot(crash, aes(x = Month)) +
  geom_bar()
```

```{r}
ggplot(crash, aes(x = Day)) +
  geom_bar()
```

```{r}
crash |>
  group_by(City) |>
  summarise(n = n()) |>
  ggplot(aes(y = City, x = n)) +
  geom_col()
```


### Data Analysis

#### Question 1: Based on the 2021 accident records in San Diego County, which day and month have the most accidents?



#### Q1: What's the answer?


#### Question 2: How does season and weather conditions impact the frequency of accidents on a given day in 2021, and what is the relationship between them?




#### Q2: What's the answer?



### Results
- RESULTS HERE

## Conclusion
- CONCLUSION HERE
